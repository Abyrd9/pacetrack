import{a as C,b as f,n as B,d as _,a4 as L,a5 as z,a6 as M,a7 as $,j as e,B as y,v as T,a8 as G,w as N,a9 as K,aa as V,x as Y,ab as W,ac as D,ad as Z,W as J,ae as X}from"./main-CGtgWssC.js";import{u as ee,a as ae,e as te,b as se,c as re,s as ne,f as E,g as ie,w as oe,Q as le,d as de,D as o,A as g,P as A,I as S}from"./image-uploader-CgZ9IX3H.js";import{u as v,c as b,a as ce,L as R,I as U,b as P}from"./input-Dl9IHLeN.js";import{M as ue,S as me}from"./send-aaqePt5S.js";import{C as k}from"./card-PlpRssu1.js";function pe(t,d,c){const u=ee(),i=ae(),s=C(),a=s.defaultQueryOptions(t);s.getDefaultOptions().queries?._experimental_beforeQuery?.(a),a._optimisticResults=u?"isRestoring":"optimistic",te(a),se(a,i),re(i);const x=!s.getQueryCache().get(a.queryHash),[n]=f.useState(()=>new d(s,a)),l=n.getOptimisticResult(a),j=!u&&t.subscribed!==!1;if(f.useSyncExternalStore(f.useCallback(m=>{const p=j?n.subscribe(B.batchCalls(m)):_;return n.updateResult(),p},[n,j]),()=>n.getCurrentResult(),()=>n.getCurrentResult()),f.useEffect(()=>{n.setOptions(a)},[a,n]),ne(a,l))throw E(a,n,i);if(ie({result:l,errorResetBoundary:i,throwOnError:a.throwOnError,query:s.getQueryCache().get(a.queryHash),suspense:a.suspense}))throw l.error;return s.getDefaultOptions().queries?._experimental_afterQuery?.(a,l),a.experimental_prefetchInRender&&!L&&oe(l,u)&&(x?E(a,n,i):s.getQueryCache().get(a.queryHash)?.promise)?.catch(_).finally(()=>{n.updateResult()}),a.notifyOnChangeProps?l:n.trackResult(l)}function O(t,d){return pe({...t,enabled:!0,suspense:!0,throwOnError:de,placeholderData:void 0},le)}function he({currentEmail:t}){const{mutate:d,data:c,isPending:u}=v({mutationFn:async s=>{const{data:a}=await b(M,{method:"POST",body:s,headers:{"Content-Type":"multipart/form-data"}});if(a.status==="error")throw new Error(a.errors?.global??"Something went wrong");return a},onError:s=>{z.error("Error sending confirmation email",s.message)}}),{fields:i}=ce({schema:$,errors:c?.errors});return e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-lg font-medium",children:"Current Email"}),c?.status==="ok"?e.jsxs("p",{className:"text-sm text-muted-foreground",children:["A confirmation link has been sent to ",c.payload?.email,". Please check your inbox."]}):e.jsxs(e.Fragment,{children:[t&&e.jsxs("p",{className:"bg-background-100 rounded-md p-2 px-4 text-sm w-fit flex items-center gap-2 mb-4",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx("span",{children:t})]}),e.jsxs("form",{method:"POST",encType:"multipart/form-data",onSubmit:s=>{s.preventDefault();const a=new FormData(s.target);d(a)},children:[e.jsx("input",{type:"hidden",name:"action",value:"change-email"}),e.jsxs("div",{className:"space-y-2 pb-4",children:[e.jsx(R,{htmlFor:i.email.name,children:"Update email address"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{type:"email",id:i.email.name,name:i.email.name,value:i.email.value,onChange:s=>i.email.onChange(s.target.value),placeholder:"new.address@example.com"}),e.jsx(y,{variant:"ghost",isLoading:u,disabled:u,type:"submit",className:"space-x-2 block w-full max-w-fit h-[38px]",children:e.jsxs(y.Loader,{className:"flex items-center space-x-2",children:[e.jsx("span",{children:"Send confirmation"}),e.jsx(me,{})]})})]}),i.email.error&&e.jsx(P,{children:i.email.error})]})]})]})]})}function xe({tenant:t,baseApiUrl:d}){const c=C(),[u,i]=f.useState(!1),s=T(),x=G("/_app").useRouteContext(),{mutate:n,data:l,isPending:j}=v({mutationFn:async m=>{const{data:p}=await b(V,{method:"POST",body:m,headers:{"Content-Type":"multipart/form-data"}});return p},onSuccess:m=>{m.status==="ok"&&(c.invalidateQueries({queryKey:[N]}),c.invalidateQueries({queryKey:[K,t?.id]}),t?.id===x.tenant?.id&&s.invalidate())}});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2.5",children:e.jsxs(o,{open:u,onOpenChange:i,children:[e.jsx(o.Trigger,{asChild:!0,children:e.jsxs("button",{type:"button",className:"relative group",children:[e.jsxs(g,{size:"lg",children:[e.jsx(g.Image,{src:`${d}/serve/${t?.image_url}`}),e.jsx(g.Fallback,{children:t?.name?.charAt(0)??"U"})]}),e.jsx("div",{className:"absolute inset-0 bg-black/50 w-full h-full flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx(A,{className:"text-white"})})]})}),e.jsx(o.Portal,{children:e.jsx(o.Overlay,{children:e.jsxs(o.Content,{children:[e.jsx(o.Title,{children:"Update Avatar"}),e.jsx(o.Description,{className:"mb-4",children:"Upload a new avatar for your account."}),t?.image_url&&e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(g,{size:"lg",children:[e.jsx(g.Image,{src:`${d}/serve/${t.image_url}`}),e.jsx(g.Fallback,{children:t?.name?.charAt(0)??"U"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-900",children:"Current avatar"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Click remove to delete this image"})]})]}),e.jsx("button",{type:"button",onClick:()=>{const m=new FormData;m.append("image","REMOVE"),m.append("id",t?.id??""),n(m),i(!1)},className:"px-3 py-1.5 text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50 rounded-md transition-colors duration-200",children:"Remove"})]})}),e.jsx(S,{ratio:"1:1",onChange:m=>{if(!m)return;const p=new FormData;p.append("image",m),p.append("id",t?.id??""),n(p),i(!1)}})]})})})]})}),j&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading avatar…"}),l?.status==="error"&&l?.errors?.image&&e.jsx(k,{className:"border-red-300 bg-red-50 text-red-700",children:e.jsx("p",{children:l.errors.image})})]})}function ge({tenant:t,tenants:d,roles:c,baseApiUrl:u}){const i=T(),s=C(),[a,x]=f.useState(!1),[n,l]=f.useState(null),{mutate:j,isPending:m}=v({mutationFn:async r=>{const{data:h}=await b(W,{method:"POST",body:r,headers:{"Content-Type":"multipart/form-data"}});return h},onSuccess:(r,h)=>{if(r.status==="ok"){x(!1),l(null);const w=h.get("tenantId");w===t.id&&i.invalidate(),s.setQueryData([N],q=>q.filter(H=>H.id!==w)),s.invalidateQueries({queryKey:[N]}),s.invalidateQueries({queryKey:[Y]})}}}),p=[];for(const r of d){if(r.kind==="personal"){p.push(r);continue}const h=c[r.id];!h||!h.allowed.includes("manage_settings")||p.push(r)}p.sort((r,h)=>r.kind==="personal"&&h.kind!=="personal"?-1:r.kind!=="personal"&&h.kind==="personal"?1:r.name.localeCompare(h.name));const F=r=>{if(r.kind==="personal")return!1;const h=c[r.id];return!(!h||!h.allowed.includes("manage_settings"))},I=r=>{l(r),x(!0)},Q=()=>{if(!n)return;const r=new FormData;r.append("action","delete-tenant"),r.append("tenantId",n.id),j(r)};return p.length===0?null:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Manage Organizations"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Delete organizations you own. This action cannot be undone."})]}),e.jsx("div",{className:"space-y-3",children:p.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{tenant:r,baseApiUrl:u}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:r.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Created"," ",r.created_at?new Date(r.created_at).toLocaleDateString():"Unknown date"]})]})]}),F(r)&&e.jsxs(o,{open:a,onOpenChange:x,children:[e.jsx(o.Trigger,{asChild:!0,children:e.jsx(y,{variant:"outline",size:"sm",onClick:()=>I(r),className:"text-red-600 border-red-600 hover:bg-red-50",children:"Delete"})}),e.jsx(o.Portal,{children:e.jsx(o.Overlay,{children:e.jsxs(o.Content,{children:[e.jsx(o.Title,{children:"Delete Organization"}),e.jsxs(o.Description,{children:['Are you sure you want to delete "',r.name,'"? This action cannot be undone and will permanently remove the organization and all its data.']}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(y,{variant:"outline",onClick:()=>x(!1),children:"Cancel"}),e.jsx(y,{variant:"default",onClick:Q,disabled:m,className:"bg-red-600 hover:bg-red-700 text-white",children:m?"Deleting...":"Delete"})]})]})})})]})]},r.id))})]})}function fe({account:t,baseApiUrl:d}){const[c,u]=f.useState(!1),i=T(),{mutate:s,data:a,isPending:x}=v({mutationFn:async n=>{const{data:l}=await b(D,{method:"POST",body:n,headers:{"Content-Type":"multipart/form-data"}});return l},onSuccess:n=>{n.status==="ok"&&i.invalidate()}});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsxs(o,{open:c,onOpenChange:u,children:[e.jsx(o.Trigger,{asChild:!0,children:e.jsxs("button",{type:"button",className:"relative group",children:[e.jsxs(g,{size:"lg",children:[e.jsx(g.Image,{src:`${d}/serve/${t?.image_url}`}),e.jsx(g.Fallback,{children:t?.display_name?.charAt(0)??"U"})]}),e.jsx("div",{className:"absolute inset-0 bg-black/50 w-full h-full flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx(A,{className:"text-white"})})]})}),e.jsx(o.Portal,{children:e.jsx(o.Overlay,{children:e.jsxs(o.Content,{children:[e.jsx(o.Title,{children:"Update Avatar"}),e.jsx(o.Description,{className:"mb-4",children:"Upload a new avatar for your account."}),e.jsx(S,{ratio:"1:1",onChange:n=>{if(!n)return;const l=new FormData;l.append("image",n),l.append("id",t?.id??""),s(l),u(!1)}})]})})})]}),e.jsxs("div",{className:"space-y-1 text-sm text-muted-foreground",children:[e.jsx("p",{className:"font-medium text-foreground",children:"Current avatar"}),e.jsx("p",{className:"text-xs",children:"Uploading a new image will replace it."})]})]}),x&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading avatar…"}),a?.status==="error"&&a?.errors?.image&&e.jsx(k,{className:"border-red-300 bg-red-50 text-red-700",children:e.jsx("p",{children:a.errors.image})})]})}function je({account:t}){const d=T(),{mutate:c,data:u,isPending:i}=v({mutationFn:async s=>{const{data:a}=await b(D,{method:"POST",body:s,headers:{"Content-Type":"multipart/form-data"}});return a},onSuccess:s=>{s.status==="ok"&&d.invalidate()}});return e.jsxs("form",{method:"post",encType:"multipart/form-data",className:"space-y-4",onSubmit:s=>{s.preventDefault();const a=new FormData(s.target);c(a)},children:[e.jsx("input",{type:"hidden",name:"action",value:"update-profile"}),e.jsx("input",{type:"hidden",name:"id",value:t?.id??""}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"display_name",children:"Display name"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{name:"display_name",defaultValue:t?.display_name??"",placeholder:"Your name"}),e.jsx(y,{variant:"ghost",type:"submit",disabled:i,className:"h-[38px] w-full max-w-fit",children:i?"Saving…":"Save changes"})]}),u?.status==="error"&&u.errors?.display_name&&e.jsx(P,{children:u.errors.display_name})]})]})}function Ce(){const t=Z.useRouteContext(),{data:d}=O(J()),{data:c}=O(X());return console.log(d),!d||!c?null:e.jsxs("main",{className:"container mx-auto max-w-xl space-y-6 py-8",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Account Settings"}),e.jsx(fe,{account:t.account,baseApiUrl:t.BASE_API_URL}),e.jsx(je,{account:t.account}),e.jsx(he,{currentEmail:t.account?.email}),e.jsx(ge,{tenant:t.tenant,tenants:d,roles:c,baseApiUrl:t.BASE_API_URL})]})}export{Ce as component};
